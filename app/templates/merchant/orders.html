{% extends 'layouts/base.html' %}

{% set page_size = 10 %}

{% macro status_label(status) %}
    {% if status == 0 %}
        {% set text = 'Pending' %}
        {% set color = 'grey' %}
    {% elif status == 1 %}
        {% set text = 'Approved' %}
        {% set color = 'green' %}
    {% elif status == 2 %}
        {% set text = 'Declined' %}
        {% set color = 'red' %}
    {% endif %}

    <div class="ui {{ color }} horizontal label">{{ text }}</div>
{% endmacro %}

{% macro order_table(order) %}
    {% set purchase_info = order.get_purchase_info() %}
    <table class="ui celled table">
        <thead>
        <tr>
            <th>Item name</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total</th>
        </tr>
        </thead>
        <tbody>
        {% for purchase in purchase_info %}
            <tr>
                <td>{{ purchase['name'] }}</td>
                <td>{{ purchase['quantity']| int() }} {{ purchase['unit'] }}</td>
                <td>{{ format_price(purchase['price']) }} / {{ purchase['unit'] }}</td>
                <td>{{ format_price(purchase['price'] * purchase['quantity']) }}</td>
            </tr>
        {% endfor %}

        </tbody>
    </table>
{% endmacro %}

{% macro order_segment(order, hide=False) %}
    {% set vendor_info = order.get_vendor_info() %}
    {% if hide %}
        {% set display = "display:none" %}
    {% endif %}
    <div class="ui segment clearing order" style="{{ display }}" id="order-{{ order.id }}">
        <div class="ui left floated basic segment" style="margin-bottom: 0px">
            <h3 class="ui header">
                Order #{{ order.id }} - {{ vendor_info['company_name'] }} {{ status_label(order.status) }}
                <div class="sub header">
                    Placed on {{ order.get_date() }}
                </div>
            </h3>
            <div><b>Total:</b> {{ order.get_total() }}</div>
            <div style="margin-top: 5px; margin-bottom: 0px"><a class="toggle-details">Show purchases</a></div>

        </div>
        <div class="ui right floated basic segment">
            <div class="ui list right">
                <div class="item"><b>Company name: </b> {{  vendor_info['company_name'] }}</div>
                {% if vendor_info['full_name'] %}
                    <div class="item"><b>Vendor name: </b> {{  vendor_info['full_name'] }}</div>
                {% endif %}
                {% if vendor_info['email'] %}
                    <div class="item"><b>Email: </b> {{  vendor_info['email'] }}</div>
                {% endif %}
            </div>
        </div>


        <div class="details" style="display: none;">
            {{ order_table(order) }}
        </div>
    </div>
{% endmacro %}

{% block content %}
    <div class="ui stackable grid container">
    <div class="sixteen wide tablet twelve wide computer centered column">
        <h2 class="ui header">
            Manage orders
            <div class="sub header">
                View and manage your orders.
            </div>
        </h2>
        {% for order in orders[:page_size] %}
            {{ order_segment(order) }}
        {% else %}
            <h3>You have not made any orders.</h3>
        {% endfor %}

        {% for order in orders[page_size:] %}
            {{ order_segment(order, hide=True) }}
        {% endfor %}

        {% if orders | length > page_size %}
            <div class="ui one column stackable center aligned page grid">
                <div class="column twelve wide">
                    <button class="ui button" id="show-more">Show more orders</button>
                </div>
            </div>
        {% endif %}

    </div>

    <script>

        $(document).ready(function(){
            $('.toggle-details').click(function () {
                var order = $( this ).closest('.order');
                var details = order.find('.details');
                details.toggle();
                if ($( this ).text() === 'Hide purchases') {
                    $(this).text('Show purchases');
                } else {
                    $( this ).text('Hide purchases');
                }
            });

            var page_size = {{ page_size }};
            var total_num_orders = {{ orders | length }};
            var current_idx = Math.min(page_size, total_num_orders);

            $('#show-more').click(function () {
                for (var i = current_idx; i < current_idx + page_size; i++) {
                    $('.order').eq(i).show();
                }
                current_idx += page_size;
                if (current_idx >= total_num_orders) {
                    $('#show-more').hide();
                }

            });

         });

    </script>
{% endblock %}
