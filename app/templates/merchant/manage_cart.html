{% extends 'layouts/base.html' %}

{% block content %}
    <div class="ui stackable grid container">
        <div class="sixteen wide tablet twelve wide computer centered column">
            <h2 class="ui header">
                Manage cart
                <div class="sub header">
                    View and manage your cart.
                </div>
            </h2>
            <form action="{{ url_for('merchant.cart_action') }}" method="post">
                <div style="overflow-x: scroll;">
                    <table class="ui searchable sortable unstackable selectable celled table">
                        <thead>
                        <tr>
                            <th class="four wide">Item name</th>
                            <th class="three wide">Company</th>
                            <th class="three wide">Vendor</th>
                            <th class="two wide">Unit price</th>
                            <th class="two wide">Quantity</th>
                            <th class="one wide">Total price</th>
                            <th class="one wide">Remove</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for item in cart | sort(attribute='listing.name') %}
                            <tr>
                                <td>{{ item.listing.name }}</td>
                                <td>{{ item.listing.vendor.company_name }}</td>
                                <td>{{ item.listing.vendor.full_name() }}</td>
                                <td>${{ item.listing.price }}</td>
                                <td>
                                    <div class="ui input fluid">
                                        <input id="quantity" name="{{ item.listing.id }}" type="number" min="0" step="1" value={{ item.quantity }}>
                                    </div>
                                </td>
                                <td id="total_price">${{ item.quantity * item.listing.price }}</td>
                                <meta id="unit_price" content={{ item.listing.price }}>
                                <td class="center aligned">
                                    <button type="submit" name="submit" class="remove-from-cart ui icon button" data="{{ item.listing.id }}" value="Remove {{ item.listing.id }}">
                                        <i class="red large trash icon"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <div class="ui buttons" id="cart_buttons">
                        <input type="submit" class="ui button" name="submit" value="Save Cart">
                        <div class="or"></div>
                        <input type="submit" class="ui positive button" name="submit" value="Order Items">
                    </div>
                </div>
                {{ form.csrf_token }}
            </form>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            $("#quantity").on('input', function() {
                var new_quantity = $("#quantity").val();
                $("#total_price").text("$" + parseInt(new_quantity)*parseFloat($("#unit_price").attr("content")))
            });
        });

        $('.remove-from-cart').click(function() {
            var toggledItemIcon = $( this );
            var listingId = toggledItemIcon.data("id");
           $.ajax({
                url: '/merchant/change_in_cart/' + listingId,
                data: JSON.stringify({
                    inCart: false,
                    quantity: 0
                }),
                contentType: "application/json",
                dataType:"json",
                success: function(data) {
                    toggledItemIcon.parent().parent().remove();
                },
                method: 'PUT'
            });
        });

    </script>
{% endblock %}